worker_processes 1; # single core focus, lower memory
worker_rlimit_nofile 65536;

events {
	worker_connections 16384;
	multi_accept on;
	use epoll;
}

http {
	# access_log /dev/stdout;
	access_log of;
	log_not_found off;
	server_tokens off;

	# gzip is disabled for maximum throughput
	gzip off;

	# TCP optimizations
	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;

	# Keepalive settings - optimized for 10k requests
	keepalive_timeout 30;
	keepalive_requests 512;
	reset_timedout_connection on;

	# Minimal buffer sizes to reduce memory usage
	client_body_buffer_size 4k;
	client_header_buffer_size 1k;
	large_client_header_buffers 2 2k;
	output_buffers 1 4k;
	postpone_output 1460;
	client_max_body_size 256k;

	# Reduced file descriptor cache for memory constraints
	open_file_cache max=2048 inactive=2s;
	open_file_cache_valid 10s;
	open_file_cache_min_uses 2;
	open_file_cache_errors off;

	upstream api {
		server api01:3000;
		server api02:3000;
		keepalive 256;
		# Use least_conn for better load distribution
		least_conn;
	}

	server {
		listen 9999 backlog=256;

		# Set request timeout to fail fast
		client_body_timeout 5s;
		client_header_timeout 5s;

		# Specific fast timeout for /payments (500ms) now stubbed locally (no upstream call)
		location = /payments {
		    proxy_pass http://api;
			proxy_http_version 1.1;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header Connection "";
			proxy_connect_timeout 10ms;
			proxy_send_timeout 10ms;
			proxy_read_timeout 2s;
			proxy_buffering off;
			proxy_buffers 4 2k;
			proxy_busy_buffers_size 4k;
			proxy_max_temp_file_size 0;
			proxy_cache off;
			proxy_intercept_errors off;
		}

		# General location for all other routes with 2s timeouts
		location / {
			proxy_pass http://api;
			proxy_http_version 1.1;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header Connection "";
			proxy_connect_timeout 2s;
			proxy_send_timeout 2s;
			proxy_read_timeout 2s;
			proxy_buffering off;
			proxy_buffers 4 2k;
			proxy_busy_buffers_size 4k;
			proxy_max_temp_file_size 0;
			proxy_cache off;
			proxy_intercept_errors off;
		}
	}
}
