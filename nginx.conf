worker_processes 1; # single core focus, lower memory
worker_rlimit_nofile 65536;

events {
	worker_connections 16384;
	multi_accept on;
	use epoll;
}

http {

	# Status code to return when connection limit exceeded
	limit_conn_status 503;
	limit_conn_log_level warn;

	# Set request rate limiting for stability
	limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;

	access_log off;
	log_not_found off;
	server_tokens off;

	# gzip is disabled for maximum throughput
	gzip off;

	# TCP optimizations
	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;

	# Keepalive settings - optimized for 10k requests
	keepalive_timeout 30;
	keepalive_requests 512;
	reset_timedout_connection on;

	# Minimal buffer sizes to reduce memory usage
	client_body_buffer_size 4k;
	client_header_buffer_size 1k;
	large_client_header_buffers 2 2k;
	output_buffers 1 4k;
	postpone_output 1460;
	client_max_body_size 256k;

	# Reduced file descriptor cache for memory constraints
	open_file_cache max=500 inactive=2s;
	open_file_cache_valid 10s;
	open_file_cache_min_uses 2;
	open_file_cache_errors off;

	upstream api {
		server api01:3000;
		server api02:3000;
		keepalive 128;
		# Use least_conn for better load distribution
		least_conn;
	}

	server {
		listen 9999 backlog=16384;

		# Apply connection limiting
		limit_conn conn_limit_per_ip 4096;

		# Set request timeout to fail fast
		client_body_timeout 10s;
		client_header_timeout 10s;

		location / {
			proxy_pass http://api;
			proxy_http_version 1.1;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

			# Keep connections alive for better performance
			proxy_set_header Connection "";

			# Increased timeout values to 10s as requested
			proxy_connect_timeout 10s;
			proxy_send_timeout 10s;
			proxy_read_timeout 10s;
			proxy_buffering on;
			proxy_buffers 4 2k;
			proxy_busy_buffers_size 4k;
			proxy_max_temp_file_size 0;
			proxy_cache off;
			proxy_intercept_errors off;
		}
	}
}
